services:
  exai-mcp-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: exai-mcp-server
    image: exai-mcp-server:latest

    # Port mapping: host:container
    # PHASE 3 (2025-10-18): Added monitoring, health check, and metrics ports
    # PORT STRATEGY FIX (2025-11-08): Using 3000-3003 range to avoid Orchestrator conflicts
    ports:
      - "3010:8079"  # WebSocket Daemon (MCP protocol) - Host 3010 → Container 8079
      - "3001:8080"  # Monitoring Dashboard (WebSocket + HTTP) - Host 3001 → Container 8080
      - "3002:8082"  # Health Check Endpoint (HTTP) - Host 3002 → Container 8082
      - "3003:8000"  # Prometheus Metrics (HTTP) - Host 3003 → Container 8000

    # Environment variables (override .env.docker)
    # TIMEZONE FIX (2025-10-18): Add consistent timezone for log correlation
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONIOENCODING=utf-8
      - TZ=Australia/Melbourne
      # Health check configuration - waits for daemon startup before testing endpoints
      - EXAI_HEALTH_CHECK_STARTUP_DELAY=15

    # Mount .env.docker as .env in container
    env_file:
      - .env.docker

    # Volume mounts for logs, documentation, and source code (development)
    # REBUILD (2025-10-19): Added all source directories for complete hot reload
    # ARCHITECTURAL FIX (2025-10-21): Added missing directories for complete hot reload
    # FILE UPLOAD FIX (2025-10-28): Added TEST_FILES_DIR mounts for cross-platform file upload
    # PORT STRATEGY FIX (2025-11-08): Added docker-compose.yml mount for file operations
    volumes:
      # Source code is now BAKED INTO the IMAGE (no volume mounts needed)
      # Volume mounts were causing issues on Windows Docker Desktop
      # - ./src:/app/src
      # - ./utils:/app/utils
      # - ./tools:/app/tools
      # - ./scripts/ws:/app/scripts/ws
      # - ./scripts/runtime:/app/scripts/runtime
      # - ./scripts/baseline_collection:/app/scripts/baseline_collection

      # Project files
      # - .:/mnt/project/EX-AI-MCP-Server  # Mount entire project for file operations
      # - ./systemprompts:/app/systemprompts  # FIX: Enable hot reload for prompt changes
      # - ./streaming:/app/streaming          # FIX: Enable hot reload for streaming changes
      # - ./static:/app/static                # FIX: Enable hot reload for static file changes

      # Data directories
      - ./logs:/app/logs
      - ./docs:/app/docs

      # Configuration (read-only)
      - ./.env.docker:/app/.env:ro

      # FILE UPLOAD FIX (2025-10-28): Mount entire project root for file upload support
      # This enables kimi_upload_files and glm_upload_file to access files from Windows host
      # Maps c:\Project\EX-AI-MCP-Server to /mnt/project/EX-AI-MCP-Server
      # Maps c:\Project\Personal_AI_Agent to /mnt/project/Personal_AI_Agent
      - c:\Project:/mnt/project:ro

    # Depends on Redis for conversation storage
    depends_on:
      redis:
        condition: service_healthy

    # Restart policy
    restart: unless-stopped

    # CRITICAL: Run automated health check on every container start
    # This ensures issues are detected and reported automatically after every rebuild
    # Updated: Run native daemon with dual protocol support (WebSocket + MCP stdio)
    # Test native MCP server directly
    command: sh -c "python scripts/health_check_automated.py || true && python -m src.daemon.ws_server"

    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s = socket.socket(); s.settimeout(2); s.connect(('127.0.0.1', 8079)); s.close(); exit(0)"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    
    # Resource limits (optional - adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    # CRITICAL FIX (P0): File descriptor limits to prevent resource exhaustion
    ulimits:
      nofile:
        soft: 4096
        hard: 8192

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Redis service for conversation persistence
  redis:
    image: redis:7-alpine
    container_name: exai-redis

    # P0-9 Security Fix: Enable Redis authentication
    # Use Redis environment variable for password
    command: sh -c "redis-server --maxmemory 4gb --maxmemory-policy allkeys-lru --appendonly yes --appendfsync everysec --auto-aof-rewrite-percentage 100 --auto-aof-rewrite-min-size 64mb --aof-load-truncated yes --aof-use-rdb-preamble yes --tcp-backlog 511 --timeout 0 --tcp-keepalive 300 --databases 16 --loglevel notice --protected-mode no --bind 0.0.0.0 --latency-monitor-threshold 100 --slowlog-log-slower-than 10000 --slowlog-max-len 128 --requirepass \$$REDIS_PASSWORD"

    # Environment variables
    # TIMEZONE FIX (2025-10-18): Add consistent timezone for log correlation
    env_file:
      - .env.docker

    environment:
      - TZ=Australia/Melbourne

    # Port mapping (exposed for debugging/monitoring)
    ports:
      - "6379:6379"

    # Volume mounts for persistence
    volumes:
      - redis-data:/data

    # Restart policy
    restart: unless-stopped

    # Health check (P0-9: Updated to use authentication)
    healthcheck:
      test: ["CMD", "sh", "-c", "echo 'auth $$REDIS_PASSWORD' | redis-cli -a $$REDIS_PASSWORD ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

    # Resource limits (4GB memory as configured in redis.conf)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 4G
        reservations:
          cpus: '0.25'
          memory: 512M

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Redis Commander for monitoring and management
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: exai-redis-commander
    restart: unless-stopped

    ports:
      - "8081:8081"

    # FINAL FIX: Using command-line args to bypass ALL config file issues
    # This avoids the buggy REDIS_HOSTS parsing AND config file issues
    command: >
      sh -c "node ./bin/redis-commander --redis-host exai-redis --redis-port 6379 --redis-password $${REDIS_PASSWORD} --redis-db 0 --http-user admin --http-password ExAi2025RedisCommander@1qaz"

    environment:
      # HTTP Basic Auth for web interface
      - TZ=Australia/Melbourne
      - REDIS_PASSWORD=${REDIS_PASSWORD}

    depends_on:
      redis:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:8081"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

# Named volumes for persistence
volumes:
  redis-data:
    driver: local
    name: exai-redis-data

# Networks (optional - for future LAN deployment)
networks:
  default:
    name: exai-network
    driver: bridge
