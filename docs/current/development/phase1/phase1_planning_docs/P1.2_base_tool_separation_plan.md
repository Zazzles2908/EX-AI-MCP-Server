# Phase 1.2: Base Tool Separation Plan

**Target**: `tools/shared/base_tool.py` (1,673 lines)  
**Goal**: Split into 4 focused modules (~400 lines each)  
**Status**: Planning

---

## Current Structure Analysis

### Lines 1-100: Imports and Class Definition
- Module docstring
- Imports (logging, ABC, typing, MCP, config, providers, utils)
- BaseTool class definition and docstring
- OpenRouter registry cache
- `__init__()` method

### Lines 104-244: Abstract Methods & Core Interface
- `get_name()` - Tool name
- `get_description()` - Tool description
- `get_input_schema()` - Input schema
- `get_system_prompt()` - System prompt
- `get_descriptor()` - Tool descriptor
- `get_annotations()` - Tool annotations
- `requires_model()` - Model requirement flag
- `is_effective_auto_mode()` - Auto mode detection

### Lines 285-632: Model Management
- `_should_require_model_selection()` - Model selection logic
- `_get_available_models()` - Available models list
- `get_model_field_schema()` - Model field schema generation
- Model provider integration
- Model context resolution

### Lines 632-762: Configuration & Validation
- `get_default_temperature()` - Default temperature
- `wants_line_numbers_by_default()` - Line numbers preference
- `get_default_thinking_mode()` - Default thinking mode
- `get_model_category()` - Model category
- `get_request_model()` - Request model
- `validate_file_paths()` - File path validation
- `_validate_token_limit()` - Token limit validation

### Lines 762-1216: File & Conversation Handling
- `get_model_provider()` - Model provider retrieval
- `get_conversation_embedded_files()` - Conversation file tracking
- `filter_new_files()` - File deduplication
- `format_conversation_turn()` - Conversation formatting
- `handle_prompt_file()` - Prompt file handling
- `get_prompt_content_for_size_validation()` - Size validation
- `check_prompt_size()` - Prompt size checking
- `_prepare_file_content_for_prompt()` - File content preparation (LARGE METHOD ~200 lines)

### Lines 1216-1670: Response Formatting & Utilities
- `get_websearch_instruction()` - Web search instructions
- `get_language_instruction()` - Language instructions
- `format_response()` - Response formatting
- `_should_require_model_selection()` - Duplicate method (line 1337)
- `_get_available_models()` - Duplicate method (line 1364)
- `_resolve_model_context()` - Model context resolution
- `validate_and_correct_temperature()` - Temperature validation
- `_parse_response()` - Response parsing

---

## Proposed 4-Module Split

### Module 1: `base_tool_core.py` (~400 lines)
**Purpose**: Core tool interface and abstract methods

**Contents**:
- Module docstring
- Imports
- BaseTool class definition
- `__init__()`
- Abstract methods:
  - `get_name()`
  - `get_description()`
  - `get_input_schema()`
  - `get_system_prompt()`
  - `get_descriptor()`
  - `get_annotations()`
  - `requires_model()`
- Core configuration methods:
  - `get_default_temperature()`
  - `get_default_thinking_mode()`
  - `get_model_category()`
  - `wants_line_numbers_by_default()`

**Lines**: ~1-100, 104-244, 632-684

---

### Module 2: `base_tool_model_management.py` (~450 lines)
**Purpose**: Model provider integration and context resolution

**Contents**:
- Model selection logic
- Model provider retrieval
- Model context resolution
- Temperature validation
- Model field schema generation

**Methods**:
- `is_effective_auto_mode()`
- `_should_require_model_selection()`
- `_get_available_models()`
- `get_model_field_schema()`
- `get_model_provider()`
- `_resolve_model_context()`
- `validate_and_correct_temperature()`
- OpenRouter registry cache methods

**Lines**: ~244-632, 781-811, 1337-1456

---

### Module 3: `base_tool_file_handling.py` (~500 lines)
**Purpose**: File processing and conversation-aware file management

**Contents**:
- File path validation
- Conversation file tracking
- File deduplication (newest-first priority)
- File content preparation
- Token-aware file embedding
- Prompt file handling

**Methods**:
- `validate_file_paths()`
- `get_conversation_embedded_files()`
- `filter_new_files()`
- `format_conversation_turn()`
- `handle_prompt_file()`
- `_prepare_file_content_for_prompt()` (LARGE - ~200 lines)
- `get_prompt_content_for_size_validation()`
- `check_prompt_size()`
- `_validate_token_limit()`

**Lines**: ~696-1216

---

### Module 4: `base_tool_response.py` (~350 lines)
**Purpose**: Response formatting and instruction generation

**Contents**:
- Response formatting
- Response parsing
- Instruction generation (web search, language)
- Request model retrieval

**Methods**:
- `get_request_model()`
- `get_websearch_instruction()`
- `get_language_instruction()`
- `format_response()`
- `_parse_response()`

**Lines**: ~684-696, 1216-1670

---

## Refactored base_tool.py (~200 lines)

**Purpose**: Composition layer using multiple inheritance

**Structure**:
```python
from tools.shared.base_tool_core import BaseToolCore
from tools.shared.base_tool_model_management import ModelManagementMixin
from tools.shared.base_tool_file_handling import FileHandlingMixin
from tools.shared.base_tool_response import ResponseFormattingMixin

class BaseTool(
    BaseToolCore,
    ModelManagementMixin,
    FileHandlingMixin,
    ResponseFormattingMixin,
    ABC
):
    """
    Abstract base class for all Zen MCP tools.
    
    Composed from specialized mixins:
    - BaseToolCore: Core interface and abstract methods
    - ModelManagementMixin: Model provider integration
    - FileHandlingMixin: File processing and conversation handling
    - ResponseFormattingMixin: Response formatting and instructions
    """
    pass
```

---

## Migration Strategy

1. **Create Module 1** (base_tool_core.py):
   - Extract core interface and abstract methods
   - Keep class definition and `__init__()`
   - Include configuration methods

2. **Create Module 2** (base_tool_model_management.py):
   - Extract model management methods
   - Include OpenRouter registry cache
   - Handle model provider integration

3. **Create Module 3** (base_tool_file_handling.py):
   - Extract file processing methods
   - Include conversation-aware file handling
   - Handle token budgeting

4. **Create Module 4** (base_tool_response.py):
   - Extract response formatting methods
   - Include instruction generation
   - Handle response parsing

5. **Refactor base_tool.py**:
   - Import all 4 modules
   - Use multiple inheritance
   - Remove all implementation code
   - Keep only composition layer

6. **Test & Validate**:
   - Run diagnostics on all files
   - Restart server
   - Verify all tools load correctly

---

## Dependencies to Handle

- `config.MCP_PROMPT_SIZE_LIMIT`
- `src.providers.ModelProvider`, `ModelProviderRegistry`
- `utils.conversation_memory`
- `utils.file_utils`
- `tools.models.ToolOutput`, `ContinuationOffer`, `SPECIAL_STATUS_MODELS`

---

## Acceptance Criteria

- ✅ All modules under 500 lines
- ✅ Clean separation of concerns
- ✅ No duplicate code
- ✅ All tools load without errors
- ✅ Server restarts successfully
- ✅ Zero breaking changes

---

**Next Steps**: Begin implementation with Module 1 (base_tool_core.py)

