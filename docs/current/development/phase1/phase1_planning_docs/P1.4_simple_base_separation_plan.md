# Phase 1.4: Simple Base Tool Separation Plan

**Target**: `tools/simple/base.py` (1,183 lines)  
**Goal**: Split into 2 focused modules (~400-500 lines each)  
**Status**: Planning

---

## Current Structure Analysis

### Overview
The file contains the `SimpleTool` class with 31 methods organized into logical groups:
- Schema and configuration methods
- Request accessor methods (hook pattern)
- Main execution flow
- Response parsing and formatting
- Continuation offer creation
- Convenience methods for prompt building

### Method Breakdown (31 methods total)

#### Lines 1-170: Core Interface & Schema (170 lines)
- Class definition and docstring
- `get_tool_fields()` - Abstract method for tool-specific fields
- `get_required_fields()` - Required field specification
- `get_annotations()` - Tool annotations
- `format_response()` - Response formatting hook
- `get_input_schema()` - Schema generation using SchemaBuilder
- `get_request_model()` - Request model class

#### Lines 173-281: Request Accessors (108 lines)
- `get_request_model_name()` - Extract model from request
- `get_request_images()` - Extract images from request
- `get_request_continuation_id()` - Extract continuation_id
- `get_request_prompt()` - Extract prompt
- `get_request_temperature()` - Extract temperature
- `get_validated_temperature()` - Temperature validation
- `get_request_thinking_mode()` - Extract thinking mode
- `get_request_files()` - Extract files
- `get_request_use_websearch()` - Extract websearch flag
- `get_request_as_dict()` - Convert request to dict
- `set_request_files()` - Set files on request
- `get_actually_processed_files()` - Get processed files

#### Lines 282-708: Main Execution Flow (426 lines)
- `execute()` - Main execution method (large, ~426 lines)
  - Request validation
  - Model context resolution
  - File processing
  - Prompt preparation
  - AI model invocation
  - Response parsing
  - Error handling

#### Lines 709-899: Response Processing (190 lines)
- `_parse_response()` - Parse and format response
- `_create_continuation_offer()` - Create continuation offer
- `_create_continuation_offer_response()` - Format continuation response

#### Lines 902-1184: Convenience Methods (282 lines)
- `build_standard_prompt()` - Standard prompt builder
- `get_prompt_content_for_size_validation()` - Size validation
- `get_websearch_guidance()` - Websearch instructions
- `handle_prompt_file_with_fallback()` - Prompt file handling
- `get_chat_style_websearch_guidance()` - Chat-style websearch
- `supports_custom_request_model()` - Custom model support
- `_validate_file_paths()` - File path validation
- `prepare_chat_style_prompt()` - Chat-style prompt preparation

---

## Proposed 2-Module Split

### Module 1: `simple_tool_execution.py` (~600 lines)
**Purpose**: Main execution flow and response processing

**Contents**:
- **Main Execution**:
  - `execute()` method (426 lines)
  - Request validation
  - Model context resolution
  - File processing
  - AI model invocation
  
- **Response Processing**:
  - `_parse_response()` method
  - `_create_continuation_offer()` method
  - `_create_continuation_offer_response()` method

**Lines**: ~600  
**Responsibility**: Tool execution and response handling

---

### Module 2: `simple_tool_helpers.py` (~400 lines)
**Purpose**: Request accessors and convenience methods

**Contents**:
- **Request Accessors** (12 methods):
  - `get_request_model_name()`
  - `get_request_images()`
  - `get_request_continuation_id()`
  - `get_request_prompt()`
  - `get_request_temperature()`
  - `get_validated_temperature()`
  - `get_request_thinking_mode()`
  - `get_request_files()`
  - `get_request_use_websearch()`
  - `get_request_as_dict()`
  - `set_request_files()`
  - `get_actually_processed_files()`
  
- **Convenience Methods** (7 methods):
  - `build_standard_prompt()`
  - `get_prompt_content_for_size_validation()`
  - `get_websearch_guidance()`
  - `handle_prompt_file_with_fallback()`
  - `get_chat_style_websearch_guidance()`
  - `supports_custom_request_model()`
  - `_validate_file_paths()`
  - `prepare_chat_style_prompt()`

**Lines**: ~400  
**Responsibility**: Request handling and prompt building utilities

---

## Refactored simple/base.py (~200 lines)

**Purpose**: Core interface and composition

**Structure**:
```python
from tools.shared.base_tool import BaseTool
from tools.simple.simple_tool_execution import SimpleToolExecutionMixin
from tools.simple.simple_tool_helpers import SimpleToolHelpersMixin

class SimpleTool(
    BaseTool,
    SimpleToolExecutionMixin,
    SimpleToolHelpersMixin,
):
    """
    Base class for simple (non-workflow) tools.
    
    Composed from:
    - BaseTool: Core tool infrastructure
    - SimpleToolExecutionMixin: Execution and response processing
    - SimpleToolHelpersMixin: Request accessors and convenience methods
    """
    
    # Common field definitions
    FILES_FIELD = SchemaBuilder.SIMPLE_FIELD_SCHEMAS["files"]
    IMAGES_FIELD = SchemaBuilder.COMMON_FIELD_SCHEMAS["images"]
    
    @abstractmethod
    def get_tool_fields(self) -> dict[str, dict[str, Any]]:
        """Return tool-specific field definitions."""
        pass
    
    def get_required_fields(self) -> list[str]:
        """Return list of required field names."""
        return []
    
    def get_annotations(self) -> Optional[dict[str, Any]]:
        """Return tool annotations."""
        return {"readOnlyHint": True}
    
    def format_response(self, response: str, request, model_info: Optional[dict] = None) -> str:
        """Format the AI response."""
        return response
    
    def get_input_schema(self) -> dict[str, Any]:
        """Generate the complete input schema."""
        return SchemaBuilder.build_schema(
            tool_specific_fields=self.get_tool_fields(),
            required_fields=self.get_required_fields(),
            model_field_schema=self.get_model_field_schema(),
            auto_mode=self.is_effective_auto_mode(),
        )
    
    def get_request_model(self):
        """Return the request model class."""
        return ToolRequest
```

**Lines**: ~200  
**Responsibility**: Core interface and composition

---

## Migration Strategy

1. **Create Module 1** (simple_tool_execution.py):
   - Extract `execute()` method
   - Extract `_parse_response()` method
   - Extract `_create_continuation_offer()` method
   - Extract `_create_continuation_offer_response()` method
   - Create SimpleToolExecutionMixin class

2. **Create Module 2** (simple_tool_helpers.py):
   - Extract all 12 request accessor methods
   - Extract all 7 convenience methods
   - Create SimpleToolHelpersMixin class

3. **Refactor simple/base.py**:
   - Import both mixins
   - Create SimpleTool using multiple inheritance
   - Keep only core interface methods
   - Remove all implementation code

4. **Test & Validate**:
   - Run diagnostics on all files
   - Restart server
   - Test simple tools (chat, status, etc.)
   - Verify conversation continuation works

---

## Dependencies to Handle

- `tools.shared.base_tool.BaseTool`
- `tools.shared.schema_builders.SchemaBuilder`
- `tools.shared.base_models.ToolRequest`
- `tools.models.ToolOutput`, `ContinuationOffer`
- `utils.conversation_memory`
- `utils.client_info`
- `mcp.types.TextContent`

---

## Acceptance Criteria

- ✅ All modules under 600 lines
- ✅ Clean separation of concerns
- ✅ No duplicate code
- ✅ All simple tools work correctly
- ✅ Conversation continuation preserved
- ✅ Server restarts successfully
- ✅ Zero breaking changes

---

**Next Steps**: Begin implementation with Module 1 (simple_tool_execution.py)

