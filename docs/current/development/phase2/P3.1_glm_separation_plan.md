# Phase 3.1: GLM Provider Separation Plan

**Date**: 2025-09-30  
**File**: `src/providers/glm.py` (409 lines)  
**Target**: Split into 3 focused modules  
**Status**: PLAN READY

---

## 📊 Current State Analysis

### File Structure
- **Total Lines**: 409
- **Main Class**: `GLMModelProvider(ModelProvider)`
- **Methods**: 12 total
- **Concerns Mixed**: Chat generation, file upload, model configuration

### Method Breakdown
1. `__init__` (lines 65-76) - Initialization with SDK/HTTP fallback
2. `get_provider_type` (lines 78-79) - Provider type
3. `validate_model_name` (lines 81-83) - Model validation
4. `supports_thinking_mode` (lines 85-88) - Thinking mode support
5. `list_models` (lines 90-91) - Model listing
6. `get_model_configurations` (lines 93-94) - Model configs
7. `get_all_model_aliases` (lines 96-101) - Aliases
8. `get_capabilities` (lines 103-119) - Capabilities
9. `count_tokens` (lines 121-139) - Token counting
10. `_build_payload` (lines 141-174) - Payload building
11. `generate_content` (lines 176-346) - **LARGEST** - Main generation method
12. `upload_file` (lines 348-409) - File upload

---

## 🎯 Proposed Module Split

### Module 1: glm_chat.py (~200 lines)
**Purpose**: Chat generation and streaming functionality

**Contents**:
- `generate_content` method (lines 176-346, ~170 lines)
- `_build_payload` method (lines 141-174, ~35 lines)
- Streaming logic (both SDK and HTTP)
- Message formatting
- Response handling

**Key Features**:
- Robust streaming with SDK/HTTP fallback
- Environment-gated streaming (GLM_STREAM_ENABLED)
- Chunk aggregation for streamed responses
- Tool/function calling support

### Module 2: glm_files.py (~65 lines)
**Purpose**: File upload functionality

**Contents**:
- `upload_file` method (lines 348-409, ~60 lines)
- File validation and size checking
- SDK/HTTP fallback for uploads
- Multipart upload handling

**Key Features**:
- Client-side size validation (GLM_FILES_MAX_SIZE_MB)
- Configurable upload timeout
- MIME type detection
- Robust error handling

### Module 3: glm_config.py (~100 lines)
**Purpose**: Model configuration and validation

**Contents**:
- `SUPPORTED_MODELS` dictionary (lines 21-63, ~40 lines)
- `validate_model_name` method (lines 81-83)
- `supports_thinking_mode` method (lines 85-88)
- `get_model_configurations` method (lines 93-94)
- `get_all_model_aliases` method (lines 96-101)
- `get_capabilities` method (lines 103-119)
- `count_tokens` method (lines 121-139, ~20 lines)

**Key Features**:
- Model capabilities definitions
- Language-aware token counting (CJK support)
- Model alias resolution
- Capability queries

### Module 4: glm.py (main file, ~50 lines)
**Purpose**: Main provider class and delegation

**Contents**:
- `GLMModelProvider` class definition
- `__init__` method with SDK/HTTP initialization
- `get_provider_type` method
- `list_models` method
- Imports from new modules
- Delegation to specialized modules

**Key Features**:
- Thin wrapper maintaining backward compatibility
- Clean imports and delegation
- SDK/HTTP client initialization

---

## 🔧 Implementation Steps

### Step 1: Create glm_config.py
1. Extract `SUPPORTED_MODELS` dictionary
2. Extract model validation and capability methods
3. Extract `count_tokens` method
4. Create module with all configuration logic

### Step 2: Create glm_files.py
1. Extract `upload_file` method
2. Include all file upload logic
3. Maintain SDK/HTTP fallback pattern
4. Preserve error handling

### Step 3: Create glm_chat.py
1. Extract `generate_content` method
2. Extract `_build_payload` method
3. Include all streaming logic
4. Maintain SDK/HTTP fallback pattern

### Step 4: Refactor glm.py
1. Create backup: `glm_BACKUP.py`
2. Import from new modules
3. Update class to delegate to modules
4. Remove extracted code
5. Maintain backward compatibility

### Step 5: Testing
1. Restart server
2. Test GLM chat functionality
3. Test GLM file upload
4. Test streaming (if enabled)
5. Verify model configuration queries

---

## 📋 Detailed Module Specifications

### glm_config.py Structure
```python
"""GLM model configuration and validation."""

from .base import ModelCapabilities, ProviderType

# Model configurations
SUPPORTED_MODELS: dict[str, ModelCapabilities] = {...}

def validate_model_name(model_name: str, supported_models: dict) -> bool:
    """Validate model name against supported models."""
    ...

def get_capabilities(model_name: str, supported_models: dict) -> ModelCapabilities:
    """Get capabilities for a model."""
    ...

def count_tokens(text: str, model_name: str) -> int:
    """Count tokens with language-aware heuristics."""
    ...

# Additional helper functions
```

### glm_files.py Structure
```python
"""GLM file upload functionality."""

import os
from pathlib import Path
import mimetypes
import logging

logger = logging.getLogger(__name__)

def upload_file(
    client,  # SDK client or HTTP client
    file_path: str,
    purpose: str = "agent",
    use_sdk: bool = False
) -> str:
    """Upload file to GLM Files API."""
    ...
```

### glm_chat.py Structure
```python
"""GLM chat generation and streaming."""

import json
import logging
import os
from typing import Any, Optional

from .base import ModelResponse, ProviderType

logger = logging.getLogger(__name__)

def build_payload(...) -> dict:
    """Build request payload for GLM API."""
    ...

def generate_content(...) -> ModelResponse:
    """Generate content with streaming support."""
    ...
```

---

## ✅ Benefits

### 1. Separation of Concerns
- ✅ Chat generation isolated
- ✅ File upload isolated
- ✅ Configuration isolated
- ✅ Each module has single responsibility

### 2. Maintainability
- ✅ Easier to understand each module
- ✅ Easier to test individual concerns
- ✅ Easier to modify without affecting others
- ✅ Clear module boundaries

### 3. Testability
- ✅ Can test chat generation independently
- ✅ Can test file upload independently
- ✅ Can test configuration independently
- ✅ Easier to mock dependencies

### 4. Scalability
- ✅ Easy to add new chat features
- ✅ Easy to add new file operations
- ✅ Easy to add new model configurations
- ✅ Room for future growth

---

## ⚠️ Considerations

### Backward Compatibility
- **CRITICAL**: All existing imports must continue to work
- Main `GLMModelProvider` class must maintain same interface
- All public methods must remain accessible
- No breaking changes to external callers

### Dependencies
- glm_chat.py depends on glm_config.py (for model resolution)
- glm_files.py is independent
- glm.py imports all modules and delegates

### Testing Requirements
- Test chat generation (streaming and non-streaming)
- Test file upload (SDK and HTTP paths)
- Test model configuration queries
- Test backward compatibility

---

## 📊 Expected Results

| Metric | Before | After | Change |
|--------|--------|-------|--------|
| **Main File Lines** | 409 | ~50 | -359 (-87.8%) |
| **glm_config.py** | - | ~100 | +100 |
| **glm_files.py** | - | ~65 | +65 |
| **glm_chat.py** | - | ~200 | +200 |
| **Total Lines** | 409 | ~415 | +6 (+1.5%) |
| **Modules** | 1 | 4 | +3 |

**Note**: Small increase in total lines due to module headers and imports, but much better organization.

---

## 🎯 Success Criteria

- ✅ Main file reduced to ~50 lines (87.8% reduction)
- ✅ 3 focused modules created
- ✅ All functionality tested and working
- ✅ Zero breaking changes
- ✅ 100% backward compatibility
- ✅ Clean separation of concerns

---

**Status**: PLAN READY - Ready for implementation  
**Estimated Time**: 30-40 minutes  
**Risk Level**: LOW (clear boundaries, good test coverage available)

