# Phase 2.1: Consensus Tool Refactoring - Separation Plan

**Date**: 2025-09-30  
**Target File**: `tools/workflows/consensus.py` (914 lines)  
**Goal**: Reduce to ~500 lines (45% reduction)  
**Status**: Planning Complete - Ready for Implementation

---

## Executive Summary

The consensus.py file (914 lines) will be refactored into 4 focused modules following the proven Phase 1 methodology. EXAI analyze tool confirmed the approach is sound with no architectural issues identified.

### Refactoring Strategy

**Extract 3 new modules** + **Refactor main file**:
1. **consensus_config.py** (~150 lines) - Field descriptions, stance prompts, constants
2. **consensus_schema.py** (~100 lines) - Schema building logic
3. **consensus_validation.py** (~80 lines) - Validation logic
4. **consensus.py** (~500 lines) - Core tool class (refactored)

**Total Reduction**: 914 → 500 lines (45% reduction, 414 lines removed from main file)

---

## Current File Structure Analysis

### Module-Level Components (lines 1-85)
- **Imports and logger** (lines 1-35): 35 lines
- **CONSENSUS_WORKFLOW_FIELD_DESCRIPTIONS** (lines 38-84): 47 lines → **EXTRACT to consensus_config.py**

### ConsensusRequest Class (lines 87-161)
- **Pydantic model** (lines 87-133): 47 lines → **KEEP in consensus.py**
- **Validator** (lines 134-161): 28 lines → **KEEP in consensus.py**

### ConsensusTool Class (lines 164-915)
- **__init__ and basic methods** (lines 173-241): 69 lines → **KEEP**
- **get_input_schema()** (lines 244-337): 94 lines → **EXTRACT to consensus_schema.py**
- **Workflow hook methods** (lines 339-466): 128 lines → **KEEP**
- **execute_workflow()** (lines 468-567): 100 lines → **KEEP**
- **_consult_model()** (lines 569-651): 83 lines → **KEEP**
- **_preflight_validate_step_one()** (lines 653-725): 73 lines → **EXTRACT to consensus_validation.py**
- **_get_stance_enhanced_prompt()** (lines 727-802): 76 lines → **EXTRACT to consensus_config.py**
- **Metadata customization** (lines 804-901): 98 lines → **KEEP**
- **Required abstract methods** (lines 902-915): 14 lines → **KEEP**

---

## Module 1: consensus_config.py (~150 lines)

**Purpose**: Configuration, field descriptions, and stance prompts

**Contents**:
1. **CONSENSUS_WORKFLOW_FIELD_DESCRIPTIONS** (47 lines)
   - All field description strings
   - Used by ConsensusRequest and schema builder

2. **STANCE_PROMPTS** (76 lines)
   - "for" stance prompt
   - "against" stance prompt
   - "neutral" stance prompt
   - Used by _get_stance_enhanced_prompt()

3. **Helper function**: `get_stance_enhanced_prompt(stance, custom_stance_prompt=None)` (20 lines)
   - Moved from ConsensusTool class
   - Returns stance-enhanced system prompt

**Exports**:
```python
__all__ = [
    "CONSENSUS_WORKFLOW_FIELD_DESCRIPTIONS",
    "STANCE_PROMPTS",
    "get_stance_enhanced_prompt",
]
```

---

## Module 2: consensus_schema.py (~100 lines)

**Purpose**: Schema building logic for consensus workflow

**Contents**:
1. **build_consensus_schema()** function (94 lines)
   - Extracted from ConsensusTool.get_input_schema()
   - Takes tool_name and model_field_schema as parameters
   - Returns complete input schema dict

**Dependencies**:
- `tools.workflow.schema_builders.WorkflowSchemaBuilder`
- `consensus_config.CONSENSUS_WORKFLOW_FIELD_DESCRIPTIONS`

**Exports**:
```python
__all__ = ["build_consensus_schema"]
```

---

## Module 3: consensus_validation.py (~80 lines)

**Purpose**: Validation logic for consensus workflow

**Contents**:
1. **validate_consensus_step_one()** function (73 lines)
   - Extracted from ConsensusTool._preflight_validate_step_one()
   - Validates models list, steps, and files
   - Raises ValueError with user-friendly messages

**Dependencies**:
- `src.providers.registry.ModelProviderRegistry`
- `os` module for file validation

**Exports**:
```python
__all__ = ["validate_consensus_step_one"]
```

---

## Module 4: consensus.py (Refactored, ~500 lines)

**Purpose**: Core consensus tool class

**Structure**:
1. **Imports** (30 lines)
   - Standard library imports
   - Third-party imports (pydantic, mcp)
   - Local imports (config, systemprompts, base classes)
   - **NEW**: Import from consensus_config, consensus_schema, consensus_validation

2. **ConsensusRequest** class (75 lines)
   - Pydantic model with fields
   - Validator for step 1 requirements
   - Uses CONSENSUS_WORKFLOW_FIELD_DESCRIPTIONS from consensus_config

3. **ConsensusTool** class (395 lines)
   - __init__ and basic methods (69 lines)
   - get_input_schema() - **SIMPLIFIED** to call build_consensus_schema() (10 lines)
   - Workflow hook methods (128 lines)
   - execute_workflow() (100 lines)
   - _consult_model() (83 lines)
   - Metadata customization (98 lines)
   - Required abstract methods (14 lines)

**Changes**:
- Import from new modules
- Replace _preflight_validate_step_one() with call to validate_consensus_step_one()
- Replace _get_stance_enhanced_prompt() with call to get_stance_enhanced_prompt()
- Simplify get_input_schema() to delegate to build_consensus_schema()

---

## Migration Strategy

### Step 1: Create consensus_config.py
1. Create new file with module docstring
2. Copy CONSENSUS_WORKFLOW_FIELD_DESCRIPTIONS
3. Copy stance prompt strings from _get_stance_enhanced_prompt()
4. Create get_stance_enhanced_prompt() function
5. Add __all__ exports

### Step 2: Create consensus_schema.py
1. Create new file with module docstring
2. Extract get_input_schema() logic to build_consensus_schema()
3. Add imports for WorkflowSchemaBuilder
4. Import CONSENSUS_WORKFLOW_FIELD_DESCRIPTIONS from consensus_config
5. Add __all__ exports

### Step 3: Create consensus_validation.py
1. Create new file with module docstring
2. Extract _preflight_validate_step_one() to validate_consensus_step_one()
3. Add imports for ModelProviderRegistry, os
4. Add __all__ exports

### Step 4: Refactor consensus.py
1. Add imports from new modules
2. Update get_input_schema() to call build_consensus_schema()
3. Remove _preflight_validate_step_one() method, call validate_consensus_step_one()
4. Remove _get_stance_enhanced_prompt() method, call get_stance_enhanced_prompt()
5. Update all references to use imported functions

### Step 5: Test and Validate
1. Restart server: `powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\ws_start.ps1 -Restart`
2. Test consensus tool via EXAI-WS MCP
3. Verify all functionality works correctly
4. Check for import errors or runtime issues

---

## Acceptance Criteria

✅ **File Size**: consensus.py reduced from 914 → ~500 lines  
✅ **Modularity**: 3 new focused modules created  
✅ **Backward Compatibility**: All existing functionality preserved  
✅ **Server Restart**: Server restarts successfully  
✅ **Tool Functionality**: Consensus tool works via EXAI-WS MCP  
✅ **No Breaking Changes**: Zero breaking changes to API  
✅ **Documentation**: Completion report created

---

## EXAI Tool Insights

**Analysis Completed**: Used `analyze_EXAI-WS` tool for comprehensive evaluation

**Key Findings**:
- ✅ Well-designed architecture with appropriate complexity
- ✅ Clear logical separation points identified
- ✅ No security issues or overengineering detected
- ✅ Refactoring will improve maintainability without changing core design
- ✅ Sequential processing pattern is MCP-compatible
- ✅ All extraction candidates maintain clear interfaces

**Recommendation**: Proceed with refactoring as planned

---

## Next Steps

1. ✅ Create separation plan (this document)
2. ⏭️ Implement refactoring (create 3 new modules + refactor main file)
3. ⏭️ Test via EXAI-WS MCP
4. ⏭️ Restart server and validate
5. ⏭️ Create completion report

---

**Status**: ✅ Planning Complete - Ready for Implementation

