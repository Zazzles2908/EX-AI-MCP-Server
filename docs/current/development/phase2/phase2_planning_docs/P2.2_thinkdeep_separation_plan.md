# Phase 2.2: ThinkDeep Tool Refactoring - Separation Plan

**Date**: 2025-09-30  
**Target File**: `tools/workflows/thinkdeep.py`  
**Current Size**: 818 lines  
**Target Size**: ~590 lines  
**Expected Reduction**: 28% (228 lines)

---

## EXAI Analysis Summary

**Tool Used**: `analyze_EXAI-WS` (3-step systematic analysis)  
**Duration**: ~3 minutes  
**Confidence**: Medium (validated architectural assessment)

### Key Findings

**Architecture**: ✅ Well-designed workflow tool
- Clear separation of concerns
- Proper inheritance from WorkflowTool base class
- Pydantic validation for type safety
- Expert analysis integration

**Scalability**: ✅ GOOD
- Environment variable configuration
- Timeout and heartbeat mechanisms
- Configurable thinking modes

**Maintainability**: ⚠️ MODERATE
- File size (818 lines) exceeds AI context limits
- Helper methods could be modularized
- Schema field overrides could be externalized
- Request model could be separated

**Security**: ✅ GOOD
- Proper Pydantic validation
- No vulnerabilities identified

**Complexity**: ✅ APPROPRIATE
- NOT overengineered
- Complexity justified for comprehensive investigation workflow
- Good candidates for modularization identified

---

## Refactoring Strategy

Unlike consensus.py (which had large config dictionaries), thinkdeep.py is primarily workflow orchestration logic. The refactoring will focus on extracting supporting components while keeping core logic together.

### Module Breakdown

#### 1. thinkdeep_models.py (~105 lines) - NEW
**Purpose**: Request model definition

**Contents**:
- ThinkDeepWorkflowRequest class (99 lines)
- Pydantic field definitions
- Validators

**Exports**:
- `ThinkDeepWorkflowRequest`

**Dependencies**:
- `pydantic`
- `tools.shared.base_models.WorkflowRequest`

---

#### 2. thinkdeep_config.py (~55 lines) - NEW
**Purpose**: Configuration and field overrides

**Contents**:
- THINKDEEP_FIELD_OVERRIDES dictionary (~40 lines)
- Environment variable helpers (if any)
- Constants

**Exports**:
- `THINKDEEP_FIELD_OVERRIDES`

**Dependencies**:
- None (pure configuration)

---

#### 3. thinkdeep_ui.py (~85 lines) - NEW
**Purpose**: UI summary helpers

**Contents**:
- _ui_summarize_text() function (~15 lines)
- _ui_build_summary() function (~70 lines)

**Exports**:
- `ui_summarize_text()`
- `ui_build_summary()`

**Dependencies**:
- Standard library only

---

#### 4. thinkdeep.py (~590 lines) - REFACTORED
**Purpose**: Core workflow tool class

**Structure**:
1. **Imports** (~45 lines)
   - Standard library
   - Third-party (pydantic, mcp)
   - Local imports
   - **NEW**: Imports from thinkdeep_models, thinkdeep_config, thinkdeep_ui

2. **ThinkDeepTool class** (~545 lines)
   - __init__ and basic methods
   - get_input_schema() - **SIMPLIFIED** (uses THINKDEEP_FIELD_OVERRIDES)
   - Workflow hook methods
   - execute_workflow()
   - Expert analysis logic
   - Helper methods (keep _get_problem_context, _get_focus_areas)
   - **REMOVED**: UI helper methods (moved to thinkdeep_ui)
   - Required abstract methods

**Changes**:
- ✅ Import ThinkDeepWorkflowRequest from thinkdeep_models
- ✅ Import THINKDEEP_FIELD_OVERRIDES from thinkdeep_config
- ✅ Import ui_summarize_text, ui_build_summary from thinkdeep_ui
- ✅ Simplify get_input_schema() to use imported THINKDEEP_FIELD_OVERRIDES
- ✅ Replace _ui_* method calls with imported functions
- ✅ Remove ThinkDeepWorkflowRequest class definition
- ✅ Remove field overrides dictionary
- ✅ Remove UI helper methods

---

## Implementation Steps

### Step 1: Create thinkdeep_models.py
1. Extract ThinkDeepWorkflowRequest class (lines 36-134)
2. Add proper imports
3. Add module docstring
4. Add __all__ exports

### Step 2: Create thinkdeep_config.py
1. Extract field overrides dictionary from get_input_schema()
2. Add module docstring
3. Add __all__ exports

### Step 3: Create thinkdeep_ui.py
1. Extract _ui_summarize_text() method
2. Extract _ui_build_summary() method
3. Convert from methods to standalone functions
4. Add module docstring
5. Add __all__ exports

### Step 4: Refactor thinkdeep.py
1. Create backup: thinkdeep_BACKUP.py
2. Add imports from new modules
3. Remove ThinkDeepWorkflowRequest class
4. Simplify get_input_schema() to use THINKDEEP_FIELD_OVERRIDES
5. Replace _ui_* method calls with function calls
6. Remove UI helper methods
7. Verify all references updated

### Step 5: Testing
1. Restart server
2. Verify no import errors
3. Test thinkdeep tool via EXAI-WS MCP
4. Verify UI summary generation works
5. Check server logs for warnings

---

## Acceptance Criteria

✅ **File Size**: thinkdeep.py reduced from 818 → ~590 lines (28% reduction)  
✅ **Modularity**: 3 new focused modules created  
✅ **Backward Compatibility**: All existing functionality preserved  
✅ **Server Restart**: Server restarts successfully  
✅ **Tool Functionality**: ThinkDeep tool works via EXAI-WS MCP  
✅ **UI Summaries**: UI summary generation functions correctly  
✅ **No Breaking Changes**: Zero breaking changes to API  
✅ **No Import Errors**: All imports resolved correctly  
✅ **No Runtime Errors**: Tool executes without errors

---

## Risk Assessment

**Low Risk Refactoring**:
- Request model extraction is straightforward
- Field overrides are pure data
- UI helpers are self-contained functions
- No complex dependencies to untangle

**Mitigation**:
- Create backup before modifications
- Test immediately after each major change
- Use EXAI codereview for validation

---

## Expected Benefits

### 1. AI Context Compatibility
- **Before**: 818 lines exceeded AI context limits
- **After**: Main file ~590 lines - fully compatible

### 2. Maintainability
- **Before**: Mixed concerns in single file
- **After**: Clear separation - models, config, UI, core logic

### 3. Testability
- **Before**: Difficult to test UI helpers independently
- **After**: UI helpers can be unit tested separately

### 4. Reusability
- **Before**: UI helpers locked in class
- **After**: UI helpers can be imported and used elsewhere

---

## Next Steps

1. ✅ EXAI analysis complete
2. ✅ Separation plan documented
3. ⏭️ Create thinkdeep_models.py
4. ⏭️ Create thinkdeep_config.py
5. ⏭️ Create thinkdeep_ui.py
6. ⏭️ Refactor thinkdeep.py
7. ⏭️ Test and validate
8. ⏭️ Create completion report

---

**Status**: Ready to proceed with implementation

