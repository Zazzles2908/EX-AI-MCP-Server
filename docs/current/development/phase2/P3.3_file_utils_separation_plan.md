# Phase 3.3: file_utils.py Refactoring Plan

**File**: `utils/file_utils.py`  
**Current Size**: 864 lines  
**Target Size**: ~80 lines  
**Expected Reduction**: 91% (784 lines)  
**Status**: READY FOR IMPLEMENTATION

---

## üìä EXAI Analysis Summary

**analyze_EXAI-WS Analysis** (Continuation ID: cd9455fb-f141-461b-8065-14dcb9febc5b):
- **3-step systematic analysis** complete
- **Confidence**: VERY_HIGH
- **Pattern**: Matches successful provider refactorings (GLM 74%, Kimi 74%)

**Current State**:
- 864 lines in single file
- 8 major functional sections
- Excellent security model
- Token-aware file reading
- Exceeds 500-line limit

---

## üéØ Refactoring Strategy

### 6-Module Split + 1 Main Wrapper

**1. file_utils_security.py** (~300 lines)
- Path validation and security checks
- MCP directory detection
- Home directory protection
- Dangerous path filtering

**2. file_utils_reading.py** (~250 lines)
- File content reading
- Line number formatting
- Error handling
- Content formatting

**3. file_utils_expansion.py** (~100 lines)
- Path expansion
- Directory walking
- File filtering

**4. file_utils_tokens.py** (~150 lines)
- Token estimation
- Size checking
- MCP boundary validation

**5. file_utils_json.py** (~50 lines)
- JSON file operations
- Read/write utilities

**6. file_utils_helpers.py** (~80 lines)
- General utility functions
- File size retrieval
- Directory creation
- Safe file reading

**7. file_utils.py** (MAIN, ~80 lines)
- Thin wrapper
- Delegates to specialized modules
- Maintains public API

---

## üìù Detailed Module Breakdown

### Module 1: file_utils_security.py

**Purpose**: Centralize all security and path validation logic

**Functions** (Lines 51-323, ~272 lines):
```python
def _is_builtin_custom_models_config(path_str: str) -> bool:
    """Check if path points to server's built-in custom_models.json"""

def is_mcp_directory(path: Path) -> bool:
    """Check if directory is MCP server's own directory"""

def get_user_home_directory() -> Optional[Path]:
    """Get user's home directory"""

def is_home_directory_root(path: Path) -> bool:
    """Check if path is user's home directory root"""

def resolve_and_validate_path(path_str: str) -> Path:
    """Resolve and validate path against security policies"""
```

**Dependencies**:
- `from .security_config import EXCLUDED_DIRS, is_dangerous_path`
- `from pathlib import Path`
- `import logging`

---

### Module 2: file_utils_reading.py

**Purpose**: File content reading and formatting

**Functions** (Lines 182-613, ~431 lines total, extract ~250):
```python
def detect_file_type(file_path: str) -> str:
    """Detect file type (text/binary/image)"""

def should_add_line_numbers(file_path: str, include_line_numbers: Optional[bool]) -> bool:
    """Determine if line numbers should be added"""

def _normalize_line_endings(content: str) -> str:
    """Normalize line endings for consistent numbering"""

def _add_line_numbers(content: str) -> str:
    """Add line numbers to text content"""

def read_file_content(file_path: str, max_size: int, *, include_line_numbers: Optional[bool]) -> tuple[str, int]:
    """Read single file and format for AI prompts"""

def read_files(file_paths: list[str], code: Optional[str], max_tokens: Optional[int], 
               reserve_tokens: int, *, include_line_numbers: bool) -> str:
    """Read multiple files with smart token management"""
```

**Dependencies**:
- `from .file_types import BINARY_EXTENSIONS, CODE_EXTENSIONS, IMAGE_EXTENSIONS, TEXT_EXTENSIONS`
- `from .token_utils import DEFAULT_CONTEXT_WINDOW, estimate_tokens`
- `from .file_utils_security import resolve_and_validate_path`
- `from .file_utils_expansion import expand_paths`

---

### Module 3: file_utils_expansion.py

**Purpose**: Path expansion and directory walking

**Functions** (Lines 326-417, ~91 lines):
```python
def expand_paths(paths: list[str], extensions: Optional[set[str]]) -> list[str]:
    """Expand paths to individual files, handling both files and directories"""
```

**Dependencies**:
- `from .file_utils_security import resolve_and_validate_path, is_home_directory_root, is_mcp_directory`
- `from .file_types import CODE_EXTENSIONS`
- `from .security_config import EXCLUDED_DIRS`
- `from pathlib import Path`
- `import os`

---

### Module 4: file_utils_tokens.py

**Purpose**: Token estimation and size validation

**Functions** (Lines 616-864, ~248 lines total, extract ~150):
```python
def estimate_file_tokens(file_path: str) -> int:
    """Estimate tokens for a file using file-type aware ratios"""

def check_files_size_limit(files: list[str], max_tokens: int, threshold_percent: float) -> tuple[bool, int, int]:
    """Check if files would exceed token limits"""

def check_total_file_size(files: list[str], model_name: str) -> Optional[dict]:
    """Check if total file sizes exceed token threshold (MCP boundary validation)"""
```

**Dependencies**:
- `from .file_types import get_token_estimation_ratio`
- `from utils.model_context import ModelContext`
- `import os`
- `import logging`

---

### Module 5: file_utils_json.py

**Purpose**: JSON file operations

**Functions** (Lines 675-714, ~39 lines):
```python
def read_json_file(file_path: str) -> Optional[dict]:
    """Read and parse JSON file with error handling"""

def write_json_file(file_path: str, data: dict, indent: int) -> bool:
    """Write data to JSON file with formatting"""
```

**Dependencies**:
- `import json`
- `import os`

---

### Module 6: file_utils_helpers.py

**Purpose**: General utility functions

**Functions** (Lines 717-792, ~75 lines):
```python
def get_file_size(file_path: str) -> int:
    """Get file size in bytes with error handling"""

def ensure_directory_exists(file_path: str) -> bool:
    """Ensure parent directory of file path exists"""

def is_text_file(file_path: str) -> bool:
    """Check if file is likely a text file"""

def read_file_safely(file_path: str, max_size: int) -> Optional[str]:
    """Read file with size limits and encoding handling"""
```

**Dependencies**:
- `from .file_types import is_text_file as check_text_type`
- `import os`

---

### Module 7: file_utils.py (MAIN)

**Purpose**: Thin wrapper maintaining public API

**Structure** (~80 lines):
```python
"""
File reading utilities with directory support and token management
[Keep original docstring]
"""

# Import all functions from specialized modules
from .file_utils_security import (
    _is_builtin_custom_models_config,
    is_mcp_directory,
    get_user_home_directory,
    is_home_directory_root,
    resolve_and_validate_path,
)

from .file_utils_reading import (
    detect_file_type,
    should_add_line_numbers,
    read_file_content,
    read_files,
)

from .file_utils_expansion import expand_paths

from .file_utils_tokens import (
    estimate_file_tokens,
    check_files_size_limit,
    check_total_file_size,
)

from .file_utils_json import (
    read_json_file,
    write_json_file,
)

from .file_utils_helpers import (
    get_file_size,
    ensure_directory_exists,
    is_text_file,
    read_file_safely,
)

# Re-export all public functions for backward compatibility
__all__ = [
    # Security
    "_is_builtin_custom_models_config",
    "is_mcp_directory",
    "get_user_home_directory",
    "is_home_directory_root",
    "resolve_and_validate_path",
    # Reading
    "detect_file_type",
    "should_add_line_numbers",
    "read_file_content",
    "read_files",
    # Expansion
    "expand_paths",
    # Tokens
    "estimate_file_tokens",
    "check_files_size_limit",
    "check_total_file_size",
    # JSON
    "read_json_file",
    "write_json_file",
    # Helpers
    "get_file_size",
    "ensure_directory_exists",
    "is_text_file",
    "read_file_safely",
]
```

---

## ‚úÖ Implementation Checklist

### Phase 1: Create Helper Modules (6 files)
- [ ] Create `utils/file_utils_security.py` (~300 lines)
- [ ] Create `utils/file_utils_reading.py` (~250 lines)
- [ ] Create `utils/file_utils_expansion.py` (~100 lines)
- [ ] Create `utils/file_utils_tokens.py` (~150 lines)
- [ ] Create `utils/file_utils_json.py` (~50 lines)
- [ ] Create `utils/file_utils_helpers.py` (~80 lines)

### Phase 2: Refactor Main File
- [ ] Create backup: `file_utils_BACKUP.py`
- [ ] Import from new modules
- [ ] Remove extracted code
- [ ] Keep original docstring
- [ ] Verify line count (~80 lines)

### Phase 3: Testing
- [ ] Restart server
- [ ] Test file reading (single file)
- [ ] Test directory expansion
- [ ] Test token estimation
- [ ] Test JSON operations
- [ ] Test security validation
- [ ] Verify all existing functionality

### Phase 4: Documentation
- [ ] Create completion report
- [ ] Update session summary
- [ ] Document any issues

---

## üéØ Expected Benefits

**Maintainability**:
- ‚úÖ 91% line reduction (864 ‚Üí ~80)
- ‚úÖ Clear separation of concerns
- ‚úÖ Testable modules
- ‚úÖ Easier to understand

**Quality**:
- ‚úÖ Reduced coupling
- ‚úÖ Improved cohesion
- ‚úÖ Better error isolation
- ‚úÖ Easier debugging

**Security**:
- ‚úÖ Centralized security logic
- ‚úÖ Easier to audit
- ‚úÖ Clear validation boundaries

---

## ‚ö†Ô∏è Risk Mitigation

**Low Risk** - Pattern proven successful:
- GLM: 74.1% reduction ‚úÖ
- Kimi: 73.6% reduction ‚úÖ
- base_tool: 93% reduction ‚úÖ

**Mitigation Strategies**:
1. Create backup before changes
2. Preserve all imports
3. Maintain error handling
4. Test incrementally
5. Zero breaking changes

---

**Status**: READY FOR IMPLEMENTATION  
**Confidence**: VERY_HIGH  
**Next Step**: Begin Phase 1 - Create helper modules

